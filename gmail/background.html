<html>
<head>
<script type="text/javascript" src="mailaccount.class.js"></script> 
<script type="text/javascript">
var img_notLoggedInSrc = "not_logged_in";
var img_noNewSrc = "no_new";
var img_newSrc = "new";
var iconSet = "set1";
var iconFormat = ".gif";
var accounts;

chrome.extension.onRequest.addListener(
  function(request, sender, sendResponse) {
    var openInTab = (localStorage["gc_open_tabs"] != null && localStorage["gc_open_tabs"] == "true");
    var disableMailTo = (localStorage["gc_no_mailto"] != null && localStorage["gc_no_mailto"] == "true");
    console.log(sender.tab ?
                "from a content script:" + sender.tab.url :
                "from the extension");
    if (request.command == "getURL" && !disableMailTo)
      sendResponse({URL: accounts[0].getURL(), openTab: openInTab});
    }
);

function init() {
    reloadSettings();
              
    // Start request loop
    window.setTimeout(startRequest, 0);
}

function reloadSettings() {
    if(localStorage["gc_poll"] == null) {
        localStorage["gc_poll"] = 15000;
    }
    
    iconSet = localStorage["gc_icon_set"];
    if(iconSet == null || iconSet == "") {
        iconSet = localStorage["gc_icon_set"] = "set1";
    }   

    setIcon(img_notLoggedInSrc);
    chrome.browserAction.setBadgeBackgroundColor({color:[190, 190, 190, 255]});
    chrome.browserAction.setBadgeText({text:"?"});
    
    if(localStorage["gc_preview_setting"] == null || 
        localStorage["gc_preview_setting"] == "") {
        localStorage["gc_preview_setting"] = "1";       
    }
    
    if(accounts != null) {
        for(var i in accounts) {
            if(accounts[i] != null) {
                accounts[i].stopScheduler();
                accounts[i] = null;
                delete accounts[i];
            }
        }
    }
    accounts = new Array();
    
    if(localStorage["gc_check_gmail_off"] == null || 
        localStorage["gc_check_gmail_off"] == "false") {
        // Create standard Gmail account
        var acc = new MailAccount();
        acc.onError = mailError;
        acc.onUpdate = mailUpdate;
        accounts.push(acc);       
    }    
    
    if(localStorage["gc_accounts"] != null) {
        var savedAccounts = eval(localStorage["gc_accounts"]);
        for(var i in savedAccounts) {
            if(savedAccounts[i] == null || savedAccounts[i].domain == null)
                break;

            var acc = new MailAccount(savedAccounts[i].domain);
            acc.onError = mailError;
            acc.onUpdate = mailUpdate;
            accounts.push(acc);
        }
    }
}

// Sets the browser action icon
function setIcon(iconName) { 
    var fullPath = "icons/" + iconSet + "/" + iconName + iconFormat;
    try {
        chrome.browserAction.setIcon({path:fullPath});
    } catch(e) {
        console.error("Could not set browser action icon '" + fullPath + "'.");
    }
}

// Request loop starter
function startRequest() {
    for(var i in accounts) {
        if(accounts[i] != null)
            accounts[i].startScheduler();
    }
}

// Called when an account has received a mail update
function mailUpdate(_account) {
    var hideCount = localStorage["gc_hide_count"];
    
    var unreadCount = 0;
    for(var i in accounts) {
        if(accounts[i] != null && accounts[i].getUnreadCount() > 0)
            unreadCount += accounts[i].getUnreadCount();
    }    
    
    if(hideCount == "true" || unreadCount < 1)
        chrome.browserAction.setBadgeText({text:""});
    else
        chrome.browserAction.setBadgeText({text:unreadCount.toString()});

    switch(unreadCount)
    {
        case 0:
            setIcon(img_noNewSrc);            
            chrome.browserAction.setBadgeBackgroundColor({color:[110, 140, 180, 255]});
            chrome.browserAction.setTitle({title:"No unread mail"});
            break;
        default:
            setIcon(img_newSrc);
            chrome.browserAction.setBadgeBackgroundColor({color:[170, 80, 80, 255]});
            chrome.browserAction.setTitle({title:unreadCount + " unread mail"});
//            popup("You have received a new mail!");
            break;
    }   
}

// Called when an account has experienced an error
function mailError(_account) {
    setIcon(img_notLoggedInSrc);
    chrome.browserAction.setBadgeBackgroundColor({color:[190, 190, 190, 255]});
    chrome.browserAction.setBadgeText({text:"X"});
    chrome.browserAction.setTitle({title:"Not logged in"});
}

// Displays a popup if the browser is minimized to tray 
// http://code.google.com/p/minimizetotray/wiki/Popups
function popup(text) {
    try {
        // Connect to extension
        var port = chrome.extension.connect("ppkfenalijoglfhgpchdegciehdlinkh", {name: 'minimize-to-tray'});
        // Send command to show up popup notification
        port.postMessage({command: 'PopupNotify', title: "Google Mail Checker Plus", text: text});
    } catch(e) { }
}
</script>
</head>
<body onload="init()">
</body>
</html>
